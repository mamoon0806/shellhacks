<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>
    Home - WalkMe
  </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="../css/globals.css" rel="stylesheet">

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxn11dlm134OPDCeb18AgK5B-rjlQ7msg&libraries=visualization&callback=initMap"
    async defer></script>
</head>

<body>
  <main class="w-full min-h-screen py-8">
    <section class="items-center">
      <h1 class="h1 font-bold text-2xl">
        <p class="text-center">
          WalkMe
        </p>
      </h1>
      <h2 class="h2 text-2xl">
        <p class="text-center">
          A web application to help you find the safest route to your destination.
        </p>
      </h2>

      <!-- Search bar -->
      <section class="flex items-center justify-center">
        <input 
          type="text"
          class="w-1/4 p-2 m-2 border border-gray-400 rounded-md input-field text-xl"
          id="fromDestinationTxtBox" 
          placeholder="Enter starting address (or Current Location)"
          onkeydown="handleKeyPress(event, 'GetDirectionsButton')"
        >
        <input type="text"
          class="w-1/4 p-2 m-2 border border-gray-400 rounded-md input-field text-xl"
          id="destination"
          placeholder="Enter destination address"
          onkeydown="handleKeyPress(event, 'GetDirectionsButton')"
        >
        <button
          class="w-1/4 p-2 m-2 border border-gray-400 rounded-md bg-blue-300 hover:bg-blue-500"
          onclick="calculateAndDisplayRoute()"
        >
          <p class="text-xl">
            Get Directions
          </p>
        </button>
      </section>
      <!-- Map container -->
      <div class="flex justify-center">
        <div id="map" class="flex h-96 w-3/4"></div>
      </div>
    </section>
  </main>

  <!-- Add your JavaScript code here -->
  <script>
    // Note: This example requires that you consent to location sharing when
    // prompted by your browser. If you see the error "The Geolocation service
    // failed.", it means you probably did not give permission for the browser to
    // locate you.
    let map, directionsService, directionsRenderer, origin, heatmap;
    let heatmapData = []; // Define an empty array to store heatmap data
    const TILE_SIZE = 256;

    function initMap() {

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 14,
        streetViewControl: false,
      });

      // Try HTML5 geolocation.
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          // Create a marker to show the user's current location
          new google.maps.Marker({
            position: pos,
            map: map,
            animation: google.maps.Animation.DROP, // Add a drop animation
          });

          map.setCenter(pos);

          directionsService = new google.maps.DirectionsService();
          directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
        },
        () => {
          handleLocationError(true, map.getCenter());
        }
      );

      // Initialize the heatmap layer
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        map: map,
        radius: 8, // Adjust the radius as needed
        opacity: 0.6, // Adjust the opacity as needed
      });

      map.addListener("zoom_changed", () => {
        center = new google.maps.LatLng(map.getCenter().lat(), map.getCenter().lng());
        console.log(getTileCoordinate(center, map.getZoom()));

        tileX = getTileCoordinate(center, map.getZoom()).x
        tileY = getTileCoordinate(center, map.getZoom()).Y

      });

      const coordMapType = new CoordMapType(new google.maps.Size(256, 256));
      map.overlayMapTypes.insertAt(0, coordMapType);

    }

    function calculateAndDisplayRoute() {
      const destination = document.getElementById('destination').value;

      if (!destination) {
        alert('Please enter a destination address.');
        return;
      }

      const request = {
        origin: map.getCenter(),
        destination: destination,
        travelMode: 'DRIVING',
      };

      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);

          // Extract points along the route for heatmap data
          const route = result.routes[0].legs[0];
          const path = route.steps.flatMap((step) => {
            return google.maps.geometry.encoding.decodePath(step.polyline.points);
          });

          // Convert the path points to LatLng objects and add them to heatmapData
          heatmapData = path.map((point) => {
            return new google.maps.LatLng(point.lat(), point.lng());
          });

          // Set the new heatmap data
          heatmap.setData(heatmapData);

          // Calculate the route distance and set the heatmap radius
          const routeDistance = route.distance.value;
          const heatmapRadius = Math.min(50, Math.max(10, routeDistance / 100));

          updateHeatmapRadius(heatmapRadius);
        } else {
          alert('Error: ' + status);
        }
      });
    }

    function calculateRoute(origin, destination) {
      const request = {
        origin: origin,
        destination: destination,
        travelMode: 'WALKING' // You can change the travel mode as needed
      };

      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          alert('Error: ' + status);
        }
      });
    }

    function getTileCoordinate(latLng, zoom){
      const scale = 1 << zoom;
      const worldCoordinate = project(latLng);

      const tileCoordinate = new google.maps.Point(
      Math.floor((worldCoordinate.x * scale) / TILE_SIZE),
      Math.floor((worldCoordinate.y * scale) / TILE_SIZE),
    );

    return tileCoordinate;

    }

    // The mapping between latitude, longitude and pixels is defined by the web
    // mercator projection.
    function project(latLng) {
      let siny = Math.sin((latLng.lat() * Math.PI) / 180);

      // Truncating to 0.9999 effectively limits latitude to 89.189. This is
      // about a third of a tile past the edge of the world tile.
      siny = Math.min(Math.max(siny, -0.9999), 0.9999);
      return new google.maps.Point(
        TILE_SIZE * (0.5 + latLng.lng() / 360),
        TILE_SIZE * (0.5 - Math.log((1 + siny) / (1 - siny)) / (4 * Math.PI)),
      );
    }

    // Function to handle Enter key press
    function handleKeyPress(event, buttonId) {
      if (event.keyCode === 13) {
        // Enter key was pressed, trigger the button click
        document.getElementById(buttonId).click();
      }
    }

    class CoordMapType {
      tileSize;
      alt = null;
      maxZoom = 16;
      minZoom = 0;
      projection = null;
      radius = 6378137;
      constructor(tileSize) {
        this.tileSize = tileSize;
      }
      getTile(coord, zoom, ownerDocument) {
        const div = ownerDocument.createElement("div");        

        let api = '/api/'
        let imgurl;
        
        let imgElement = document.createElement("img");
        imgElement.style.width = '500px';
        imgElement.style.height = '500px';
        imgElement.style.position = 'absolute';
        imgElement.style.top = '0';
        imgElement.style.left = '0';
        imgElement.style.zIndex = '50';
      
        try {
          fetch("/api/1/0/0")
            .then(response => {
              console.log(response);
              response = response.blob()
            })
            .then(
              blob => {
                const newBlob = new Blob([blob], { type: "image/png" });
                imgurl = URL.createObjectURL(newBlob);
                imgElement.src = imgurl;
                console.log(imgurl);
              }
            )
        } catch (err) {
          console.log("lol");
        }

        div.appendChild(imgElement); 
        div.innerHTML = String(coord);
        div.style.width = this.tileSize.width + "px";
        div.style.height = this.tileSize.height + "px";
        div.style.fontSize = "10";
        div.style.borderStyle = "solid";
        div.style.borderWidth = "1px";
        div.style.borderColor = "#AAAAAA";

        return div;
      }
      releaseTile(tile) {}
      
}
  </script>

</body>

</html>